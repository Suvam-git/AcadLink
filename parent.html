<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcadLink - Parent Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Notifications/Alerts Section */
        .alerts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .alert-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #667eea;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-card.homework-pending {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .alert-card.achievement {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .alert-card.warning {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .alert-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .alert-card h3 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .alert-card p {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
        }

        .alert-action {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-action:hover {
            transform: scale(1.05);
        }

        /* Card Styling */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Ward Selection */
        .ward-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .ward-btn {
            padding: 10px 16px;
            border: 2px solid #e6e9f8;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ward-btn:hover {
            border-color: #667eea;
            background: #f3f6ff;
        }

        .ward-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* Time Management */
        .time-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .time-box {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .time-box h3 {
            font-size: 14px;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .time-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
        }

        .time-unit {
            font-size: 13px;
            color: #666;
        }

        .time-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .time-input-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .time-input-group input {
            padding: 10px 12px;
            border: 2px solid #e6e9f8;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .time-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Progress Section */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f3f6ff 0%, #f0ebff 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.3);
        }

        .achievement-badge.locked {
            background: #e5e7eb;
            color: #999;
            box-shadow: none;
        }

        .achievement-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .achievement-name {
            font-size: 12px;
            font-weight: 600;
        }

        /* Homework Status */
        .homework-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .homework-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .homework-item.completed {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .homework-item.pending {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .homework-item.overdue {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .homework-title {
            font-weight: 600;
            color: #333;
        }

        .homework-due {
            font-size: 13px;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Communication */
        .feedback-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feedback-form textarea {
            padding: 12px;
            border: 2px solid #e6e9f8;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        .feedback-form textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Messages List */
        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .message-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .message-sender {
            font-weight: 600;
            font-size: 13px;
            color: #667eea;
            margin-bottom: 5px;
        }

        .message-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .message-time {
            font-size: 11px;
            color: #999;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        /* Streak Display */
        .streak-info {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .streak-number {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .streak-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .time-management {
                grid-template-columns: 1fr;
            }

            .homework-item {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
            }

            .header-right {
                flex-direction: column;
                width: 100%;
            }

            .alerts-section {
                grid-template-columns: 1fr;
            }

            .progress-grid {
                grid-template-columns: 1fr;
            }

            .ward-selector {
                flex-direction: column;
            }

            .ward-btn {
                width: 100%;
                text-align: center;
            }
        }

        .recommendation-box {
            background: #f3f6ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #666;
        }

        .recommendation-box strong {
            color: #667eea;
        }

        .success-message {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üë®‚Äçüë©‚Äçüëß Parent Dashboard</h1>
        <div class="header-right">
            <div class="user-info">
                <span id="parentName">Parent Name</span>
                <span id="parentEmail">parent@school.com</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Ward Selection -->
        <div class="section-title">üë∂ Your Ward(s)</div>
        <div class="ward-selector">
            <button class="ward-btn active" onclick="selectWard('ward1', 'Rahul Kumar')">Rahul Kumar (Class 10-A)</button>
            <button class="ward-btn" onclick="selectWard('ward2', 'Priya Kumar')">Priya Kumar (Class 9-B)</button>
        </div>

        <!-- Time Management -->
        <div class="card">
            <h2>‚è±Ô∏è Ward's Productive Time Management</h2>
            
            <div class="section-title" style="margin: 0 0 20px 0; font-size: 16px; border-bottom: none; padding-bottom: 0;">
                Set & Monitor Free Time
            </div>

            <div class="time-management">
                <!-- App Suggested Time -->
                <div class="time-box">
                    <h3>App Recommended</h3>
                    <div class="time-value" id="suggestedTime">180</div>
                    <div class="time-unit">minutes/day based on curriculum</div>
                    <div class="recommendation-box" style="margin-top: 12px;">
                        <strong>Why this?</strong> Based on your ward's grade and curriculum load, we recommend <strong>3 hours</strong> of daily practice for optimal learning.
                    </div>
                </div>

                <!-- Teacher Expected Time -->
                <div class="time-box">
                    <h3>Teacher Expects</h3>
                    <div class="time-value" id="teacherTime">150</div>
                    <div class="time-unit">minutes/day for assignments</div>
                    <div class="recommendation-box" style="margin-top: 12px;">
                        <strong>From Teacher:</strong> Mr. Sharma suggests at least <strong>2.5 hours</strong> for homework and practice.
                    </div>
                </div>
            </div>

            <div class="time-input-group" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e6e9f8;">
                <label>üéØ Set Your Ward's Daily Free Time (minutes)</label>
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">This is the productive time you're allocating for studies. The app will track your ward's usage against this goal.</p>
                <div style="display: flex; gap: 10px; align-items: end;">
                    <div style="flex: 1;">
                        <input type="number" id="customTime" placeholder="Enter time in minutes" min="30" max="480" value="180">
                    </div>
                    <button class="btn-primary" onclick="setFreeTime()">Set Time</button>
                </div>
                <div class="success-message" id="timeSuccess">‚úÖ Free time has been set! Your ward will now see this target in their app.</div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="card">
            <h2>üìä Your Ward's Performance</h2>
            
            <!-- Streak Display -->
            <div class="streak-info">
                <div class="streak-number" id="streakNumber">üî• -</div>
                <div class="streak-label">Day Learning Streak</div>
            </div>

            <!-- Statistics -->
            <div class="progress-grid">
                <div class="stat-card">
                    <div class="stat-number" id="overallGrade">-</div>
                    <div class="stat-label">Overall Grade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="homeworkCompletion">-</div>
                    <div class="stat-label">Homework Completion</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgMarks">-</div>
                    <div class="stat-label">Average Marks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="dailyStudy">-</div>
                    <div class="stat-label">Avg. Daily Study</div>
                </div>
            </div>
        </div>

        <!-- Achievements -->
        <div class="card">
            <h2>üèÜ Recent Achievements</h2>
            <div class="achievements-grid" id="achievementsGrid">
                <div class="muted">No achievements yet.</div>
            </div>
        </div>

        <!-- Homework Status -->
        <div class="card">
            <h2>üìã Homework & Assignment Status</h2>
            <div class="homework-list">
                <div class="homework-item completed">
                    <div>
                        <div class="homework-title">Math - Chapter 3: Algebra Basics</div>
                        <div class="homework-due">Completed on Feb 14, 2:30 PM</div>
                    </div>
                    <div><span class="status-badge status-completed">‚úì Completed</span></div>
                    <div>Score: 9/10</div>
                    <div>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                </div>

                <div class="homework-item pending">
                    <div>
                        <div class="homework-title">Science - Practical: Chemical Reactions</div>
                        <div class="homework-due">Due: Feb 15, 5:00 PM</div>
                    </div>
                    <div><span class="status-badge status-pending">‚è≥ Pending</span></div>
                    <div>In Progress</div>
                    <div></div>
                </div>

                <div class="homework-item completed">
                    <div>
                        <div class="homework-title">English - Essay: My Future Dreams</div>
                        <div class="homework-due">Completed on Feb 13, 7:45 PM</div>
                    </div>
                    <div><span class="status-badge status-completed">‚úì Completed</span></div>
                    <div>Score: 8/10</div>
                    <div>‚≠ê‚≠ê‚≠ê‚≠ê</div>
                </div>

                <div class="homework-item pending">
                    <div>
                        <div class="homework-title">History - Project: Indian Independence</div>
                        <div class="homework-due">Due: Feb 16, 11:59 PM</div>
                    </div>
                    <div><span class="status-badge status-pending">‚è≥ Pending</span></div>
                    <div>Not Started</div>
                    <div></div>
                </div>

                <div class="homework-item overdue">
                    <div>
                        <div class="homework-title">Geography - Map Marking</div>
                        <div class="homework-due">Was Due: Feb 14, 5:00 PM</div>
                    </div>
                    <div><span class="status-badge status-overdue">‚ö†Ô∏è Overdue</span></div>
                    <div>5% late penalty</div>
                    <button class="alert-action" onclick="sendEducationMsg()">Encourage Now</button>
                </div>
            </div>
        </div>

        <!-- Communication with Teacher -->
        <div class="card">
            <h2>üí¨ Messages from Teacher</h2>
            <div class="messages-list" id="messagesList">
                <div class="muted">No messages yet.</div>
            </div>
        </div>

        <!-- Send Feedback to Teacher -->
        <div class="card">
            <h2>üìß Send Feedback to Teacher</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Share concerns, questions, or positive feedback about your ward's learning experience and progress.</p>
            <div class="feedback-section">
                <div class="feedback-form">
                    <textarea id="feedbackText" placeholder="Write your message or concern here..."></textarea>
                    <button class="btn-primary" onclick="sendFeedback()">Send to Teacher</button>
                    <div class="success-message" id="feedbackSuccess">‚úÖ Your message has been sent to the teacher!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Education Tips -->
    <div id="educationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tips to Encourage Your Ward</h3>
                <button class="close-btn" onclick="closeModal('educationModal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <p style="font-weight: 600; margin-bottom: 8px;">üéØ Create a Study Schedule</p>
                    <p style="font-size: 13px; color: #666;">Set consistent study times daily. This helps build discipline and routine.</p>
                </div>
                <div>
                    <p style="font-weight: 600; margin-bottom: 8px;">üì± Minimize Distractions</p>
                    <p style="font-size: 13px; color: #666;">Ensure phone and other gadgets are kept away during study hours.</p>
                </div>
                <div>
                    <p style="font-weight: 600; margin-bottom: 8px;">üéâ Celebrate Small Wins</p>
                    <p style="font-size: 13px; color: #666;">Praise your ward for completing assignments on time and maintaining streaks.</p>
                </div>
                <div>
                    <p style="font-weight: 600; margin-bottom: 8px;">üí¨ Communicate Regularly</p>
                    <p style="font-size: 13px; color: #666;">Ask about what they learned today and show genuine interest in their education.</p>
                </div>
                <button class="btn-primary" onclick="closeModal('educationModal')">Got It</button>
            </div>
        </div>
    </div>

    <script>
        // Dynamic parent dashboard using localStorage
        function getCurrentParent() {
            const raw = localStorage.getItem('loggedInUser');
            if (!raw) return null;
            try {
                const parsed = JSON.parse(raw);
                const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
                const id = parsed && (parsed.id || parsed.parentId || parsed.userId);
                if (id) {
                    const fresh = users.parents.find(p => String(p.id) === String(id));
                    if (fresh) {
                        localStorage.setItem('loggedInUser', JSON.stringify(fresh));
                        return fresh;
                    }
                }
                if (parsed && parsed.email) {
                    const fresh = users.parents.find(p => p.email === parsed.email);
                    if (fresh) { localStorage.setItem('loggedInUser', JSON.stringify(fresh)); return fresh; }
                }
                return parsed;
            } catch (e) { return null; }
        }

        function initParentDashboard() {
            const parent = getCurrentParent();
            if (!parent) { window.location.href = 'login.html'; return; }
            document.getElementById('parentName').textContent = parent.firstName + ' ' + parent.lastName;
            document.getElementById('parentEmail').textContent = parent.email || '';
            renderWardSelector(parent);
            checkNotifications();
            setInterval(checkNotifications, 300000);
        }

        function renderWardSelector(parent) {
            const selector = document.querySelector('.ward-selector');
            selector.innerHTML = '';
            // Add input to request ward by roll no
            const addBox = document.createElement('div');
            addBox.style.display = 'flex';
            addBox.style.gap = '8px';
            addBox.style.alignItems = 'center';
            addBox.innerHTML = `
                <input id="wardRoll" placeholder="Roll No" style="padding:8px;border-radius:8px;border:1px solid #e6e9f8" />
                <input id="wardClass" placeholder="Class (optional)" style="padding:8px;border-radius:8px;border:1px solid #e6e9f8" />
                <button class="ward-btn" onclick="requestWardConnection()">Request Ward</button>
            `;
            selector.appendChild(addBox);

            // Render accepted wards as buttons
            const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
            const wards = (parent.wards || []).slice();
            if (wards.length === 0) {
                const msg = document.createElement('div'); msg.className = 'muted'; msg.textContent = 'No wards connected yet.'; selector.appendChild(msg);
                return;
            }
            wards.forEach(sid => {
                const student = users.students.find(s => String(s.id) === String(sid));
                if (!student) return;
                const btn = document.createElement('button');
                btn.className = 'ward-btn';
                btn.textContent = `${student.firstName} ${student.lastName} (${student.class || '-'})`;
                btn.onclick = () => renderSelectedWard(student.id);
                selector.appendChild(btn);
            });
            // auto-render first connected ward
            if (wards.length > 0) {
                const first = users.students.find(s => String(s.id) === String(wards[0]));
                if (first) renderSelectedWard(first.id);
            }
        }

        function requestWardConnection() {
            const roll = document.getElementById('wardRoll').value.trim();
            const cls = document.getElementById('wardClass').value.trim();
            const parent = getCurrentParent();
            if (!roll) { alert('Please enter the student roll number.'); return; }
            const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
            const student = users.students.find(s => (s.rollNo && String(s.rollNo) === String(roll)) && (cls ? s.class === cls : true));
            if (!student) { alert('Student not found with that roll number/class.'); return; }

            // Add request to student.parentRequests
            student.parentRequests = student.parentRequests || [];
            // avoid duplicate pending
            const exists = student.parentRequests.find(r => String(r.parentId) === String(parent.id) && r.status === 'pending');
            if (exists) { alert('You already requested connection for this student.'); return; }
            student.parentRequests.push({ parentId: parent.id, parentName: parent.firstName + ' ' + parent.lastName, parentEmail: parent.email, date: new Date().toISOString(), status: 'pending' });

            // track requested wards on parent (optional)
            parent.requestedWards = parent.requestedWards || [];
            if (!parent.requestedWards.find(r => String(r) === String(student.id))) parent.requestedWards.push(student.id);

            // save
            users.students = users.students.map(s => s.id === student.id ? student : s);
            users.parents = users.parents.map(p => p.id === parent.id ? parent : p);
            localStorage.setItem('acadlinkUsers', JSON.stringify(users));
            localStorage.setItem('loggedInUser', JSON.stringify(parent));

            alert('Connection request sent. The student must accept to complete linking.');
            renderWardSelector(parent);
        }

        function renderSelectedWard(studentId) {
            window.currentWardId = studentId;
            const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
            const student = users.students.find(s => String(s.id) === String(studentId));
            if (!student) return;

            // Homeworks
            const list = document.querySelector('.homework-list');
            if (!student.homeworks || student.homeworks.length === 0) {
                list.innerHTML = '<div class="muted">No homeworks for this ward.</div>';
            } else {
                let html = '';
                student.homeworks.slice().reverse().forEach(h => {
                    const status = h.completed ? '<span class="status-badge status-completed">‚úì Completed</span>' : '<span class="status-badge status-pending">‚è≥ Pending</span>';
                    html += `<div class="homework-item ${h.completed? 'completed': 'pending'}"><div><div class="homework-title">${h.title}</div><div class="homework-due">${h.dueDate? 'Due: '+h.dueDate : ''}</div></div><div>${status}</div><div>${h.score? 'Score: '+h.score : ''}</div><div>${h.rating? '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê':''}</div></div>`;
                });
                list.innerHTML = html;
            }

            // Performance stats
            const overallGradeEl = document.getElementById('overallGrade');
            const hwCompEl = document.getElementById('homeworkCompletion');
            const avgMarksEl = document.getElementById('avgMarks');
            const dailyStudyEl = document.getElementById('dailyStudy');
            const streakEl = document.getElementById('streakNumber');

            const overallGrade = student.overallGrade || (student.points ? (Math.min(5, (student.points/20).toFixed(1))) : '-');
            overallGradeEl.textContent = overallGrade || '-';

            // homework completion: compute from homeworks
            let hwCompletion = '-';
            if (student.homeworks && student.homeworks.length > 0) {
                const done = student.homeworks.filter(h => h.completed).length;
                hwCompletion = Math.round((done / student.homeworks.length) * 100) + '%';
            } else if (student.homeworkCompletion) hwCompletion = (student.homeworkCompletion + '%');
            hwCompEl.textContent = hwCompletion;

            // avg marks
            let avg = '-';
            if (student.homeworks && student.homeworks.length > 0) {
                const scores = student.homeworks.map(h => h.score).filter(s => typeof s === 'number');
                if (scores.length) avg = Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
            } else if (typeof student.avgMarks === 'number') avg = student.avgMarks;
            avgMarksEl.textContent = (avg === '-') ? '-' : (avg + '%');

            dailyStudyEl.textContent = student.dailyStudyTime ? (student.dailyStudyTime + ' hrs') : (student.avgDailyStudy ? (student.avgDailyStudy + ' hrs') : '-');
            streakEl.textContent = 'üî• ' + (student.streak || '-');

            // Achievements
            const achievementsGrid = document.getElementById('achievementsGrid');
            achievementsGrid.innerHTML = '';
            const achs = student.achievements || [];
            if (!achs || achs.length === 0) {
                achievementsGrid.innerHTML = '<div class="muted">No achievements yet.</div>';
            } else {
                achs.slice().reverse().forEach(a => {
                    const badge = document.createElement('div'); badge.className = 'achievement-badge';
                    const icon = document.createElement('div'); icon.className = 'achievement-icon'; icon.textContent = a.icon || 'üèÜ';
                    const name = document.createElement('div'); name.className = 'achievement-name'; name.textContent = a.title || a.name || 'Achievement';
                    badge.appendChild(icon); badge.appendChild(name);
                    achievementsGrid.appendChild(badge);
                });
            }

            // Messages from teachers
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';
            const msgs = student.teacherMessages || student.messages || student.notifications || [];
            if (!msgs || msgs.length === 0) {
                messagesList.innerHTML = '<div class="muted">No messages yet.</div>';
            } else {
                msgs.slice().reverse().forEach(m => {
                    const div = document.createElement('div'); div.className = 'message-item';
                    const sender = document.createElement('div'); sender.className = 'message-sender'; sender.textContent = (m.fromName || m.sender || m.teacherName || 'Teacher');
                    const text = document.createElement('div'); text.className = 'message-text'; text.textContent = m.text || m.message || m.body || '';
                    const time = document.createElement('div'); time.className = 'message-time'; time.textContent = m.date ? new Date(m.date).toLocaleString() : (m.time || '');
                    div.appendChild(sender); div.appendChild(text); div.appendChild(time);
                    messagesList.appendChild(div);
                });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', initParentDashboard);

        // Check Notifications
        function checkNotifications() {
            const chance = Math.random();
            
            if (chance > 0.7) {
                document.getElementById('homeworkAlert').style.display = 'flex';
            } else {
                document.getElementById('homeworkAlert').style.display = 'none';
            }

            if (chance > 0.6) {
                document.getElementById('achievementAlert').style.display = 'flex';
            } else {
                document.getElementById('achievementAlert').style.display = 'none';
            }

            if (chance > 0.5) {
                document.getElementById('streakAlert').style.display = 'flex';
            } else {
                document.getElementById('streakAlert').style.display = 'none';
            }
        }

        // Send Feedback
        function sendFeedback() {
            const feedback = document.getElementById('feedbackText').value;
            
            if (!feedback.trim()) {
                alert('‚ö†Ô∏è Please write a message before sending!');
                return;
            }

            const successMsg = document.getElementById('feedbackSuccess');
            successMsg.style.display = 'block';
            document.getElementById('feedbackText').value = '';
            
            setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
        }

        // Send Education Message
        function sendEducationMsg() {
            alert('üì® Encouraging message sent to your ward along with a reminder to complete the homework!');
        }

        // View Functions
        function viewHomework() {
            alert('Viewing homework details... This would show full assignment details in a modal.');
        }

        function viewAchievements() {
            alert('Viewing all achievements... This would display detailed achievement history.');
        }

        function viewTeacherMessages() {
            const id = window.currentWardId;
            if (!id) { alert('Please select a ward to view messages.'); return; }
            const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
            const student = users.students.find(s => String(s.id) === String(id));
            if (!student) { alert('Ward not found.'); return; }
            const msgs = student.teacherMessages || student.messages || student.notifications || [];
            if (!msgs || msgs.length === 0) { alert('No messages for this ward.'); return; }
            let txt = 'Messages:\n\n';
            msgs.slice().reverse().forEach(m => { txt += `${m.date? new Date(m.date).toLocaleString() : ''} ‚Äî ${(m.fromName||m.sender||m.teacherName||'Teacher')}: ${m.text||m.message||m.body||''}\n\n`; });
            alert(txt);
        }

        function viewProgress() {
            alert('Viewing detailed progress report...');
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                alert('Logged out successfully!');
                window.location.href = 'login.html';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('educationModal');
            if (event.target === modal) {
                modal.classList.remove('active');
            }
        }
    </script>
</body>
</html>
