<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AcadLink - Student Dashboard</title>
    <style>
        /* Modal styles for daily emotion check */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 22px; border-radius: 12px; width: 420px; max-width: 92%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-bottom: 8px; color: #333; }
        .modal-feelings { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
        .modal-feelings button{ padding:10px 12px; border-radius:10px; border:1px solid #e6e9f8; background:#fff; cursor:pointer }
        .modal-feelings button.selected{ background:#667eea; color:#fff; border-color:#667eea }
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#f7fbff,#eef4ff);min-height:100vh}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:18px 24px;display:flex;justify-content:space-between;align-items:center}
        .header .left{display:flex;flex-direction:column}
        .header h1{font-size:20px}
        .header .meta{opacity:.95}
        .logout{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
        .container{max-width:1100px;margin:22px auto;padding:0 18px}
        .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px}
        .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(17,24,39,0.06)}
        .card h2{font-size:18px;margin-bottom:12px;color:#333}
        .homework-item{border-left:4px solid #667eea;padding:12px;margin-bottom:12px;border-radius:8px}
        .muted{color:#666;font-size:13px}
        .points{font-size:28px;font-weight:700;color:#667eea}
        .ach-list{display:flex;flex-direction:column;gap:8px}
        .ach{background:#f3f6ff;padding:10px;border-radius:8px}
        .feeling-buttons{display:flex;gap:8px;flex-wrap:wrap}
        .feeling-buttons button{padding:10px 12px;border-radius:10px;border:1px solid #e6e9f8;background:#fff;cursor:pointer}
        .feeling-buttons button.selected{background:#667eea;color:#fff;border-color:#667eea}
        .feedback-area textarea{width:100%;height:90px;padding:10px;border-radius:8px;border:1px solid #e6e9f8}
        .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
        .small{font-size:13px;color:#666}
        .rank-box{display:flex;gap:12px;align-items:center}
        .rank-num{background:#fff;border:2px solid #667eea;color:#667eea;padding:10px 14px;border-radius:10px;font-weight:700}
        @media(max-width:900px){.grid{grid-template-columns:1fr}.header{flex-direction:column;gap:8px}}
    </style>
</head>
<body>
    <div class="header">
        <div class="left">
            <h1>Welcome, <span id="studentName">Student</span></h1>
            <div class="meta small" id="studentMeta" style="color: white;">Class ‚Ä¢ Section</div>
        </div>
        <div class="right">
            <div style="text-align:right">
                <div class="small" style="color: white;">Points</div>
                <div class="points" style="color: white;" id="studentPoints">0</div>
            </div>
            <div style="width:12px"></div>
            <div style="text-align:right">
                <div class="small" style="color: white;">Streak</div>
                <div class="small" id="streakDisplay" style="color: wheat;">0 days</div>
            </div>
            <div style="width:12px"></div>
            <button class="logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Mandatory Daily Emotion Modal (blocks until submitted) -->
    <div id="feelingModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true">
            <h3>How are you feeling today?</h3>
            <p class="small">This helps your school support you. Please select one to continue.</p>
            <div class="modal-feelings" id="modalFeelingButtons">
                <button data-feeling="Happy">üòä Happy</button>
                <button data-feeling="Calm">üòå Calm</button>
                <button data-feeling="Okay">üôÇ Okay</button>
                <button data-feeling="Sad">üò¢ Sad</button>
                <button data-feeling="Anxious">üò∞ Anxious</button>
                <button data-feeling="Excited">ü§© Excited</button>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
                <button class="btn-primary" id="modalSubmitFeeling">Submit</button>
            </div>
        </div>
    </div>

    <!-- AI Chat Sidebar Placeholder -->
    <div id="aiSidebar" style="position:fixed;right:18px;bottom:18px;z-index:1200;display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <button id="aiToggle" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 8px 20px rgba(102,126,234,0.2)">AI Chat</button>
        <div id="aiPanel" style="width:360px;max-width:86vw;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.15);overflow:hidden;display:none">
            <div style="padding:12px;border-bottom:1px solid #eee;background:#fafafa;font-weight:600">Assistant</div>
            <div style="padding:14px;color:#666">This is a placeholder for the AI assistant. AI can be added to make it expandable.</div>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div>
                <div class="card">
                    <h2>Homeworks</h2>
                    <div id="homeworksList">
                        <div class="muted">No homeworks assigned for your class yet.</div>
                    </div>
                </div>

                <div class="card" style="margin-top:14px">
                    <h2>Achievements</h2>
                    <div id="achievementsList" class="ach-list">
                        <div class="muted">You have no achievements yet. Keep going ‚Äî you're doing great!</div>
                    </div>
                </div>

                <div class="card" style="margin-top:14px" id="parentRequestsCard">
                    <h2> Parent Requests</h2>
                    <div id="parentRequestsList">
                        <div class="muted">No parent requests at the moment.</div>
                    </div>
                </div>

                <div class="card" style="margin-top:14px">
                    <h2>Daily Emotion Check</h2>
                    <p class="small" id="feelingNote">Help us understand how you're feeling today ‚Äî it's private and helps your school support you.</p>
                    <div id="feelingSection">
                        <div class="feeling-buttons" id="feelingButtons">
                            <button data-feeling="Happy">üòä Happy</button>
                            <button data-feeling="Calm">üòå Calm</button>
                            <button data-feeling="Okay">üôÇ Okay</button>
                            <button data-feeling="Sad">üò¢ Sad</button>
                            <button data-feeling="Anxious">üò∞ Anxious</button>
                            <button data-feeling="Excited">ü§© Excited</button>
                        </div>
                        <div style="margin-top:12px">
                            <button class="btn-primary" id="submitFeelingBtn">Submit Feeling</button>
                        </div>
                    </div>
                    <div id="feelingStatus" class="small" style="margin-top:10px;color:green;display:none"></div>
                </div>

                <div class="card" style="margin-top:14px">
                    <h2>Feedback (sent to Admin)</h2>
                    <p class="small">Your feedback will be sent for support. It is handled by the admin; for help with urgent matters, contact your school staff.</p>
                    <div class="feedback-area">
                        <textarea id="feedbackText" placeholder="Write your feedback or problem here..."></textarea>
                        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
                            <button class="btn-primary" id="sendFeedbackBtn">Send Feedback</button>
                            <div id="feedbackStatus" class="small" style="color:green;display:none">Sent</div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>Your Performance</h2>
                    <div style="margin-bottom:12px">
                        <div class="small">Points</div>
                        <div class="points" id="sidePoints">0</div>
                    </div>
                    <div style="margin-bottom:12px">
                        <div class="small">Class Rank</div>
                        <div class="rank-box"><div class="rank-num" id="rankNum">-</div><div class="small" id="rankInfo">out of - students</div></div>
                    </div>
                    <div>
                        <h3 style="font-size:15px;margin-bottom:8px">Kind Notes</h3>
                        <div class="small">Keep trying ‚Äî learning is a journey. Celebrate small wins and ask for help when you need it.</div>
                    </div>
                </div>

                <div class="card" style="margin-top:14px">
                    <h2>Quick Actions</h2>
                    <div style="display:flex;flex-direction:column;gap:8px">
                        <button class="btn-primary" onclick="viewPastFeelings()">View Past Feelings</button>
                        <button class="btn-primary" onclick="viewAchievements()">View Achievements</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getTodayDate() {
            const d = new Date();
            return d.toISOString().split('T')[0];
        }

        function getCurrentUser() {
            const raw = localStorage.getItem('loggedInUser');
            if (!raw) return null;
            try {
                const parsed = JSON.parse(raw);
                // If parsed is an object with id, prefer the authoritative entry from acadlinkUsers
                const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
                const maybeId = parsed && (parsed.id || parsed.studentId || parsed.userId);
                if (maybeId) {
                    const fresh = users.students.find(s => String(s.id) === String(maybeId));
                    if (fresh) {
                        // refresh the stored loggedInUser so student sees latest data
                        localStorage.setItem('loggedInUser', JSON.stringify(fresh));
                        return fresh;
                    }
                }
                // fallback: try to match by email/username
                if (parsed && parsed.email) {
                    const fresh = users.students.find(s => s.email === parsed.email) || users.teachers.find(t => t.email === parsed.email) || users.parents.find(p => p.email === parsed.email);
                    if (fresh) {
                        localStorage.setItem('loggedInUser', JSON.stringify(fresh));
                        return fresh;
                    }
                }
                return parsed;
            } catch (err) {
                return null;
            }
        }

        function updateUserInStorage(updatedUser) {
            const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
            // find in students list
            users.students = users.students.map(s => s.id === updatedUser.id ? updatedUser : s);
            localStorage.setItem('acadlinkUsers', JSON.stringify(users));
            localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        function loadDashboard() {
            const user = getCurrentUser();
            if (!user) { window.location.href = 'login.html'; return; }

            document.getElementById('studentName').textContent = user.firstName + ' ' + user.lastName;
            document.getElementById('studentMeta').textContent = (user.class || '-') + ' ‚Ä¢ ' + (user.section || '-');
            document.getElementById('studentPoints').textContent = user.points || 0;
            document.getElementById('sidePoints').textContent = user.points || 0;

            loadHomeworks(user);
            renderAchievements(user);
            renderFeelingState(user);
            renderParentRequests(user);
            computeRank(user);
            // If student hasn't submitted today's feeling, force modal
            showFeelingModalIfNeeded(user);
        }

        function loadHomeworks(user) {
            // Prefer per-student homeworks stored on the user object (teachers add there).
            const list = document.getElementById('homeworksList');
            const relevant = (user.homeworks || []).slice().reverse();
            if (!relevant || relevant.length === 0) {
                list.innerHTML = '<div class="muted">No homeworks assigned for your class yet.</div>';
                return;
            }
            let html = '';
            relevant.forEach(h => {
                const title = h.title || h.name || h.heading || h.subject || 'Untitled Assignment';
                const status = h.completed ? '<span class="small" style="color:green">‚úì Completed</span>' : '<span class="small" style="color:#ff9900">‚è≥ Pending</span>';
                html += `<div class="homework-item"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${title}</strong><div class="muted" style="margin-top:6px">${h.description || ''}</div></div><div style="text-align:right">${status}<div class="small">Due: ${h.dueDate || '-'}</div></div></div></div>`;
            });
            list.innerHTML = html;
        }

        function renderAchievements(user) {
            const list = document.getElementById('achievementsList');
            const arr = user.achievements || [];
            if (arr.length === 0) {
                list.innerHTML = '<div class="muted">You have no achievements yet. Keep going ‚Äî you\'re doing great!</div>';
                return;
            }
            let html = '';
            arr.forEach(a => { html += `<div class="ach">${a.title} <div class="small">${a.date || ''}</div></div>`; });
            list.innerHTML = html;
        }

        // Feelings
        let selectedFeeling = null;
        document.getElementById('feelingButtons').addEventListener('click', function(e){
            if (e.target.tagName === 'BUTTON'){
                selectedFeeling = e.target.getAttribute('data-feeling');
                document.querySelectorAll('#feelingButtons button').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        document.getElementById('submitFeelingBtn').addEventListener('click', function(){
            const user = getCurrentUser();
            if (!selectedFeeling) { alert('Please select how you feel today.'); return; }
            const today = getTodayDate();
            // check if already submitted today
            const existing = (user.feelings || []).find(f => f.date === today);
            if (existing) { document.getElementById('feelingStatus').style.display='block'; document.getElementById('feelingStatus').textContent = 'You have already submitted your feeling for today.'; return; }
            const entry = { date: today, feeling: selectedFeeling };
            user.feelings = user.feelings || [];
            user.feelings.push(entry);
            // update storage
            updateUserInStorage(user);

            // also add to global feedback array if needed (not necessary). Admin reads from user.feelings.
            document.getElementById('feelingStatus').style.display='block';
            document.getElementById('feelingStatus').textContent = 'Thanks for sharing ‚Äî your feeling was recorded.';
            setTimeout(()=>{ document.getElementById('feelingStatus').style.display='none'; },3000);
        });

        function renderFeelingState(user) {
            const today = getTodayDate();
            const existing = (user.feelings || []).find(f => f.date === today);
            if (existing) {
                document.getElementById('feelingStatus').style.display='block';
                document.getElementById('feelingStatus').textContent = 'You submitted: ' + existing.feeling + ' today.';
                // highlight selected
                document.querySelectorAll('#feelingButtons button').forEach(b => {
                    if (b.getAttribute('data-feeling') === existing.feeling) b.classList.add('selected');
                });
            }
        }

        // Parent requests: render pending requests and allow acceptance
        function renderParentRequests(user) {
            const list = document.getElementById('parentRequestsList');
            const requests = user.parentRequests || [];
            if (!requests || requests.length === 0) {
                list.innerHTML = '<div class="muted">No parent requests at the moment.</div>';
                return;
            }
            let html = '';
            requests.forEach(req => {
                if (req.status === 'pending') {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f2f7"><div><strong>${req.parentName}</strong><div class="small">Requested on ${req.date || ''}</div></div><div><button class="btn-primary" onclick="acceptParentRequest(${req.parentId})">Accept</button></div></div>`;
                }
            });
            list.innerHTML = html || '<div class="muted">No parent requests at the moment.</div>';
        }

        function acceptParentRequest(parentId) {
            const user = getCurrentUser();
            if (!user) return;
            const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
            const parent = users.parents.find(p => String(p.id) === String(parentId));
            if (!parent) { alert('Parent not found.'); return; }

            // Add parent id to student's parents list
            user.parents = user.parents || [];
            if (!user.parents.find(p => String(p) === String(parentId))) user.parents.push(parentId);

            // Mark request as accepted
            user.parentRequests = (user.parentRequests || []).map(r => r.parentId === parentId ? Object.assign({}, r, { status: 'accepted' }) : r);

            // Add student to parent's wards
            parent.wards = parent.wards || [];
            if (!parent.wards.find(w => String(w) === String(user.id))) parent.wards.push(user.id);

            // Persist both
            // update users.students entry
            users.students = users.students.map(s => s.id === user.id ? user : s);
            users.parents = users.parents.map(p => p.id === parent.id ? parent : p);
            localStorage.setItem('acadlinkUsers', JSON.stringify(users));

            // refresh local loggedInUser for student
            localStorage.setItem('loggedInUser', JSON.stringify(user));

            showTemporaryMessage('Parent connection accepted.');
            renderParentRequests(user);
        }

        function showTemporaryMessage(msg) {
            const el = document.createElement('div');
            el.textContent = msg;
            el.style.position = 'fixed';
            el.style.bottom = '18px';
            el.style.left = '18px';
            el.style.background = '#10b981';
            el.style.color = 'white';
            el.style.padding = '10px 14px';
            el.style.borderRadius = '8px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        // Modal: mandatory daily emotion
        let modalSelectedFeeling = null;
        document.addEventListener('click', function(e){
            // modal buttons
            const mb = document.getElementById('modalFeelingButtons');
            if (mb && mb.contains(e.target) && e.target.tagName === 'BUTTON') {
                modalSelectedFeeling = e.target.getAttribute('data-feeling');
                mb.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        document.getElementById('modalSubmitFeeling').addEventListener('click', function(){
            const user = getCurrentUser();
            if (!modalSelectedFeeling) { alert('Please select how you feel today.'); return; }
            const today = getTodayDate();
            const existing = (user.feelings || []).find(f => f.date === today);
            if (existing) {
                hideFeelingModal();
                return;
            }
            const entry = { date: today, feeling: modalSelectedFeeling };
            user.feelings = user.feelings || [];
            user.feelings.push(entry);
            updateUserInStorage(user);
            // reflect on-page
            document.getElementById('feelingStatus').style.display='block';
            document.getElementById('feelingStatus').textContent = 'You submitted: ' + modalSelectedFeeling + ' today.';
            // highlight on-page buttons as well
            document.querySelectorAll('#feelingButtons button').forEach(b => {
                if (b.getAttribute('data-feeling') === modalSelectedFeeling) b.classList.add('selected'); else b.classList.remove('selected');
            });
            hideFeelingModal();
        });

        function showFeelingModalIfNeeded(user) {
            const today = getTodayDate();
            const existing = (user.feelings || []).find(f => f.date === today);
            if (!existing) {
                document.getElementById('feelingModal').classList.add('active');
                document.body.style.overflow = 'hidden';
                // reset modal selection
                modalSelectedFeeling = null;
                const mb = document.getElementById('modalFeelingButtons');
                if (mb) mb.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            }
        }

        function hideFeelingModal() {
            document.getElementById('feelingModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Feedback
        document.getElementById('sendFeedbackBtn').addEventListener('click', function(){
            const msg = document.getElementById('feedbackText').value.trim();
            if (!msg) { alert('Please enter a message to send.'); return; }
            const user = getCurrentUser();
            const store = JSON.parse(localStorage.getItem('acadlinkFeedbacks') || '[]');
            const entry = { id: Date.now(), studentId: user.id, studentName: user.firstName + ' ' + user.lastName, date: new Date().toISOString(), message: msg };
            store.push(entry);
            localStorage.setItem('acadlinkFeedbacks', JSON.stringify(store));
            document.getElementById('feedbackText').value = '';
            document.getElementById('feedbackStatus').style.display='block';
            setTimeout(()=>{ document.getElementById('feedbackStatus').style.display='none'; },2500);
        });

        function computeRank(user) {
            const users = JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students":[],"teachers":[],"parents":[]}');
            const students = users.students.filter(s => (s.class||'') === (user.class||'') && (s.section||'') === (user.section||''));
            if (students.length === 0) { document.getElementById('rankNum').textContent='-'; document.getElementById('rankInfo').textContent='out of 0 students'; return; }
            students.sort((a,b)=> (b.points||0) - (a.points||0));
            const idx = students.findIndex(s => s.id === user.id);
            if (idx === -1) { document.getElementById('rankNum').textContent='-'; document.getElementById('rankInfo').textContent=`out of ${students.length} students`; return; }
            document.getElementById('rankNum').textContent = (idx+1);
            document.getElementById('rankInfo').textContent = `out of ${students.length} students`;
        }

        // Helpers to view
        function viewPastFeelings(){
            const user = getCurrentUser();
            const arr = user.feelings || [];
            if (arr.length===0) { alert('No past feelings recorded'); return; }
            let txt = 'Past feelings:\n';
            arr.slice().reverse().forEach(f=> txt += `${f.date}: ${f.feeling}\n`);
            alert(txt);
        }
        function viewAchievements(){
            const user = getCurrentUser();
            const arr = user.achievements || [];
            if (arr.length===0) { alert('No achievements yet.'); return; }
            let txt = 'Achievements:\n';
            arr.slice().reverse().forEach(a=> txt += `${a.date||''}: ${a.title}\n`);
            alert(txt);
        }

        // AI sidebar toggle behavior
        document.getElementById('aiToggle').addEventListener('click', function(){
            const p = document.getElementById('aiPanel');
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>