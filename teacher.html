<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcadLink - Teacher Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Notifications Area */
        .notifications-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .notification-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #667eea;
            display: flex;
            align-items: start;
            gap: 15px;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification-card.low-load {
            border-left-color: #fbbf24;
            background: #fffbeb;
        }

        .notification-card.inactive {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .notification-card.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .notification-icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .notification-content h3 {
            margin-bottom: 5px;
            font-size: 16px;
        }

        .notification-content p {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .notification-action {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-action:hover {
            transform: scale(1.05);
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Card Styling */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Priority Setting */
        .priority-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .priority-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .priority-input-group label {
            font-weight: 600;
            color: #333;
        }

        .priority-input-group input,
        .priority-input-group select,
        .priority-input-group textarea {
            padding: 10px 12px;
            border: 2px solid #e6e9f8;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .priority-input-group input:focus,
        .priority-input-group select:focus,
        .priority-input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .difficulty-levels {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .difficulty-btn {
            padding: 10px 14px;
            border: 2px solid #e6e9f8;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .difficulty-btn:hover {
            border-color: #667eea;
            background: #f3f6ff;
        }

        .difficulty-btn.easy {
            border-color: #10b981;
            color: #10b981;
        }

        .difficulty-btn.easy.selected {
            background: #10b981;
            color: white;
        }

        .difficulty-btn.medium {
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .difficulty-btn.medium.selected {
            background: #fbbf24;
            color: white;
        }

        .difficulty-btn.hard {
            border-color: #ef4444;
            color: #ef4444;
        }

        .difficulty-btn.hard.selected {
            background: #ef4444;
            color: white;
        }

        /* Activity Tracking */
        .activity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activity-table th {
            background: #f3f6ff;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e6e9f8;
            font-size: 13px;
            color: #667eea;
        }

        .activity-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .activity-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Marks Management */
        .marks-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .marks-input-group {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .marks-input-group select,
        .marks-input-group input {
            padding: 10px 12px;
            border: 2px solid #e6e9f8;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .marks-input-group select:focus,
        .marks-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Student List */
        .student-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .student-name {
            font-weight: 600;
            color: #333;
        }

        .marks-display {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 600;
            color: #667eea;
        }

        .streak-display {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: #667eea;
        }

        .streak-fire {
            font-size: 16px;
        }

        .edit-marks-btn {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .edit-marks-btn:hover {
            background: #764ba2;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #333;
        }

        /* Load Status */
        .load-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .progress-container {
            background: #f3f6ff;
            padding: 14px;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e6e9f8;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 300ms ease;
        }

        .load-stat {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .load-stat.low {
            border-left-color: #fbbf24;
        }

        .load-stat.medium {
            border-left-color: #3b82f6;
        }

        .load-stat.high {
            border-left-color: #10b981;
        }

        .load-stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .load-stat-label {
            font-size: 13px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .marks-input-group {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
            }

            .header-right {
                flex-direction: column;
                width: 100%;
            }

            .student-item {
                grid-template-columns: 1fr;
            }

            .notifications-section {
                grid-template-columns: 1fr;
            }
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inactive-notice {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .inactive-notice p {
            font-size: 14px;
            color: #991b1b;
            margin-bottom: 10px;
        }

        .dismiss-btn {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .dismiss-btn:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üìö Teacher Dashboard</h1>
        <div class="header-right">
            <div class="user-info">
                <span id="teacherName">Teacher Name</span>
                <span id="teacherClass">Class 10-A</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Notifications & Activity Status -->
        <div class="notifications-section">
            <!-- Class Load Notification -->
            <!-- Teacher Inactivity (supportive) -->
            <div id="teacherInactiveNotif" class="notification-card inactive" style="display: none;">
                <div class="notification-icon">ü§ù</div>
                <div class="notification-content">
                    <h3>We Missed You ‚Äî Gentle Reminder</h3>
                    <p id="teacherInactiveMsg">It‚Äôs been a couple of days since your last login. A short check‚Äëin or quick assignment helps students stay on track. Need a suggested activity?</p>
                    <button class="notification-action" onclick="openQuickComposer()">Create Quick Activity</button>
                </div>
            </div>

            <!-- Student Engagement -->
            <!-- (Removed class-load and student support notifications as requested) -->
        </div>

        <!-- Load Status Overview -->
        <div class="section-title">üìä Class Overview</div>
        <div class="load-status">
            <div class="load-stat high">
                <div class="load-stat-number" id="activeCount">0</div>
                <div class="load-stat-label">Students Active (24h)</div>
            </div>

            <div class="load-stat medium">
                <div class="load-stat-number" id="ongoingCount">0</div>
                <div class="load-stat-label">Assignments (7d)</div>
            </div>
            <div class="load-stat low">
                <div class="load-stat-number" id="upcomingCount">0</div>
                <div class="load-stat-label">Upcoming Assignments</div>
            </div>
        </div>
        </div> 

        <!-- Workload dashboard removed per request; assignments panel added in sidebar -->

        <!-- Main Content Grid -->
        <div class="main-grid" style="grid-template-columns: 1fr 1fr 340px;">
            <!-- Priority & Content Difficulty -->
            <div class="card">
                <h2>üìù Set Priority & Content Load</h2>
                <div class="priority-form">
                    <div class="priority-input-group">
                        <label>Topic/Assignment Name</label>
                        <input type="text" id="priorityTopic" placeholder="e.g., Algebra Basics">
                    </div>

                    <div class="priority-input-group">
                        <label>Difficulty Level</label>
                        <div class="difficulty-levels">
                            <button class="difficulty-btn easy" onclick="selectDifficulty('easy')">üü¢ Easy</button>
                            <button class="difficulty-btn medium" onclick="selectDifficulty('medium')">üü° Medium</button>
                            <button class="difficulty-btn hard" onclick="selectDifficulty('hard')">üî¥ Hard</button>
                        </div>
                        <input type="hidden" id="selectedDifficulty" value="">
                    </div>

                    <div class="priority-input-group">
                        <label>Live Preview</label>
                        <div id="composerPreview" style="background:#f8f9ff;padding:10px;border-radius:8px;color:#333;font-size:14px;">No draft yet. Enter details to see impact on weekly load.</div>
                    </div>

                    <div class="priority-input-group">
                        <label>Estimated Duration (minutes)</label>
                        <input type="number" id="priorityDuration" placeholder="e.g., 45" min="5" max="180">
                    </div>

                    <div class="priority-input-group">
                        <label>Description</label>
                        <textarea id="priorityDescription" placeholder="Brief description of the content..." rows="3"></textarea>
                    </div>

                    <button class="btn-primary" onclick="setPriority()">Set Priority & Notify Students</button>
                </div>

                <div class="inactive-notice" id="prioritySuccess" style="display: none;">
                    <p>‚úÖ Priority has been set and students have been notified about the content difficulty!</p>
                </div>
            </div>

            <!-- Add Practical Marks -->
            <div class="card">
                <h2>üìä Add Practical Marks</h2>
                <div class="marks-form">
                    <div class="marks-input-group">
                        <div style="display:flex;gap:8px;align-items:center;">
                            <select id="studentSelect" placeholder="Select Student">
                                <option value="">-- Select Student --</option>
                            </select>
                            <input id="studentSearch" type="text" placeholder="Search students" style="padding:8px;border:2px solid #e6e9f8;border-radius:8px;font-size:14px;"> 
                        </div>
                        <input type="number" id="marksInput" placeholder="Marks (0-100)" min="0" max="100">
                        <button class="btn-primary" onclick="addMarks()">Add Marks</button>
                    </div>

                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px;">
                        <div style="display:flex;gap:8px;align-items:center;">
                            <label style="font-weight:600;color:#333;">Sort:</label>
                            <select id="studentSort">
                                <option value="name">Name</option>
                                <option value="marks">Marks</option>
                                <option value="streak">Streak</option>
                            </select>
                        </div>
                        <div style="font-size:13px;color:#666;">Filter applies to displayed class</div>
                    </div>

                    <div class="student-list" id="studentMarks">
                        <div class="student-item">
                            <span class="student-name">Aarav Kumar</span>
                            <span class="marks-display">85/100</span>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input data-student-id="student1" class="inline-mark-input" type="number" value="85" min="0" max="100" style="width:72px;padding:6px;border:1px solid #e6e9f8;border-radius:6px;text-align:center;"> 
                                <button class="edit-marks-btn" onclick="viewStudentMarks('student1')">View</button>
                            </div>
                        </div>

                        <div class="student-item">
                            <span class="student-name">Bhavna Singh</span>
                            <span class="marks-display">92/100</span>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input data-student-id="student2" class="inline-mark-input" type="number" value="92" min="0" max="100" style="width:72px;padding:6px;border:1px solid #e6e9f8;border-radius:6px;text-align:center;"> 
                                <button class="edit-marks-btn" onclick="viewStudentMarks('student2')">View</button>
                            </div>
                        </div>

                        <div class="student-item">
                            <span class="student-name">Chirag Patel</span>
                            <span class="marks-display">78/100</span>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input data-student-id="student3" class="inline-mark-input" type="number" value="78" min="0" max="100" style="width:72px;padding:6px;border:1px solid #e6e9f8;border-radius:6px;text-align:center;"> 
                                <button class="edit-marks-btn" onclick="viewStudentMarks('student3')">View</button>
                            </div>
                        </div>

                        <div class="student-item">
                            <span class="student-name">Divya Sharma</span>
                            <span class="marks-display">88/100</span>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input data-student-id="student4" class="inline-mark-input" type="number" value="88" min="0" max="100" style="width:72px;padding:6px;border:1px solid #e6e9f8;border-radius:6px;text-align:center;"> 
                                <button class="edit-marks-btn" onclick="viewStudentMarks('student4')">View</button>
                            </div>
                        </div>

                        <div class="student-item">
                            <span class="student-name">Eshaan Gupta</span>
                            <span class="marks-display">95/100</span>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input data-student-id="student5" class="inline-mark-input" type="number" value="95" min="0" max="100" style="width:72px;padding:6px;border:1px solid #e6e9f8;border-radius:6px;text-align:center;"> 
                                <button class="edit-marks-btn" onclick="viewStudentMarks('student5')">View</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignments / Details Sidebar -->
            <div class="card" id="assignmentsPanel">
                <h2>Details</h2>
                <div id="assignmentsList" style="display:flex;flex-direction:column;gap:10px;">
                    <div style="color:#666;font-size:13px;">No assignments yet for your selected sections.</div>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px;">
                    <button class="btn-primary" onclick="exportAssignments()">Export JSON</button>
                    <button class="btn-primary" onclick="importAssignments()">Import</button>
                </div>
            </div>
        </div>

        <!-- Student Activity & Engagement -->
        <div class="card" style="margin-top: 30px;">
            <h2>üë• Student Activity Status</h2>
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Last Active</th>
                        <th>Status</th>
                        <th>Assignments Done</th>
                        <th>Marks</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Aarav Kumar</td>
                        <td>5 mins ago</td>
                        <td><span class="activity-status status-active">Active</span></td>
                        <td>8/10</td>
                        <td>üî• 7 days</td>
                        <td><button class="edit-marks-btn" onclick="alert('Send motivation message')">Message</button></td>
                    </tr>
                    <tr>
                        <td>Bhavna Singh</td>
                        <td>12 mins ago</td>
                        <td><span class="activity-status status-active">Active</span></td>
                        <td>9/10</td>
                        <td>üî• 12 days</td>
                        <td><button class="edit-marks-btn" onclick="alert('Send praise message')">Message</button></td>
                    </tr>
                    <tr>
                        <td>Chirag Patel</td>
                        <td>2 hours ago</td>
                        <td><span class="activity-status status-inactive">Inactive</span></td>
                        <td>5/10</td>
                        <td>üî• 3 days</td>
                        <td><button class="edit-marks-btn" onclick="alert('Send engagement notice')">Notify</button></td>
                    </tr>
                    <tr>
                        <td>Divya Sharma</td>
                        <td>15 mins ago</td>
                        <td><span class="activity-status status-active">Active</span></td>
                        <td>8/10</td>
                        <td>üî• 9 days</td>
                        <td><button class="edit-marks-btn" onclick="alert('Send motivation message')">Message</button></td>
                    </tr>
                    <tr>
                        <td>Eshaan Gupta</td>
                        <td>1 min ago</td>
                        <td><span class="activity-status status-active">Active</span></td>
                        <td>10/10</td>
                        <td>üî• 15 days</td>
                        <td><button class="edit-marks-btn" onclick="alert('Send praise message')">Message</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Editing Marks -->
    <div id="editMarksModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Student Marks</h3>
                <button class="close-btn" onclick="closeModal('editMarksModal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Student</label>
                    <input type="text" id="modalStudentName" readonly style="padding: 10px 12px; border: 2px solid #e6e9f8; border-radius: 8px; background: #f9fafb;">
                </div>
                <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Practical Marks (0-100)</label>
                    <input type="number" id="modalMarks" min="0" max="100" style="padding: 10px 12px; border: 2px solid #e6e9f8; border-radius: 8px; width: 100%;">
                </div>
                <button class="btn-primary" onclick="saveMarkChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Helper to read/write central DB
        function getUsersDB() {
            return JSON.parse(localStorage.getItem('acadlinkUsers') || '{"students": [], "teachers": [], "parents": []}');
        }

        function saveUsersDB(db) {
            localStorage.setItem('acadlinkUsers', JSON.stringify(db));
        }

        function getLoggedInUser() {
            return JSON.parse(localStorage.getItem('loggedInUser') || 'null');
        }

        function saveLoggedInUser(user) {
            localStorage.setItem('loggedInUser', JSON.stringify(user));
        }

        // Ensure only teachers access this page
        function checkTeacherAccess() {
            const role = localStorage.getItem('userRole');
            if (role !== 'teacher') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // State
        let currentTeacher = null;
        let db = null;
        const RECOMMENDED_WEEKLY = 240; // minutes

        document.addEventListener('DOMContentLoaded', function() {
            if (!checkTeacherAccess()) return;

            db = getUsersDB();
            const logged = getLoggedInUser();
            if (!logged) {
                window.location.href = 'login.html';
                return;
            }

            // Find teacher in DB to get latest assignedClasses
            currentTeacher = db.teachers.find(t => t.id === logged.id) || logged;
            // Ensure structure
            currentTeacher.assignedClasses = currentTeacher.assignedClasses || [];

            // Update header
            document.getElementById('teacherName').textContent = `${currentTeacher.firstName || ''} ${currentTeacher.lastName || ''}`.trim() || 'Teacher';
            document.getElementById('teacherClass').textContent = currentTeacher.assignedClasses.length ? formatAssignedClasses(currentTeacher.assignedClasses) : 'No classes selected';

            renderClassSelection();
            renderStudentsList();
            refreshActivityStatus();

            setInterval(refreshActivityStatus, 30000);
            setInterval(checkTeacherInactivity, 60000);

            // composer live preview bindings
            ['priorityTopic','priorityDuration','selectedDifficulty'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateComposerPreview);
            });
            document.getElementById('studentSearch').addEventListener('input', () => renderStudentsList());
            document.getElementById('studentSort').addEventListener('change', () => renderStudentsList());
        });

        function formatAssignedClasses(arr) {
            return arr.map(a => `${a.class}-${a.section || ''}`).join(', ');
        }

        // Render available class/section combos from students
        function renderClassSelection() {
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '8px';

            const header = document.createElement('div');
            header.innerHTML = '<strong>Select Classes & Sections you manage</strong>';
            container.appendChild(header);

            // derive unique combos
            const combos = {};
            db.students.forEach(s => {
                const cls = s.class || 'Unassigned';
                const sec = s.section || '';
                const key = cls + '||' + sec;
                combos[key] = { class: cls, section: sec };
            });

            const listDiv = document.createElement('div');
            listDiv.style.display = 'flex';
            listDiv.style.flexWrap = 'wrap';
            listDiv.style.gap = '10px';

            Object.keys(combos).forEach(key => {
                const combo = combos[key];
                const id = `combo_${btoa(key)}`;
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '6px';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.id = id;
                cb.dataset.cls = combo.class;
                cb.dataset.sec = combo.section;
                if (currentTeacher.assignedClasses.find(a => a.class === combo.class && (a.section || '') === (combo.section || ''))) {
                    cb.checked = true;
                }
                cb.addEventListener('change', onAssignedClassesChange);

                const span = document.createElement('span');
                span.textContent = combo.class + (combo.section ? ' - ' + combo.section : '');

                label.appendChild(cb);
                label.appendChild(span);
                listDiv.appendChild(label);
            });

            container.appendChild(listDiv);

            // Place at top of container (below header)
            const parent = document.querySelector('.container');
            // remove existing selection area if present
            const existing = document.getElementById('classSelectionArea');
            if (existing) existing.remove();

            const wrapper = document.createElement('div');
            wrapper.id = 'classSelectionArea';
            wrapper.className = 'card';
            wrapper.style.marginBottom = '20px';
            wrapper.innerHTML = '<h2>üè∑Ô∏è Manage Classes</h2>';
            wrapper.appendChild(container);

            parent.insertBefore(wrapper, parent.firstChild.nextSibling);
        }

        function onAssignedClassesChange() {
            const boxes = Array.from(document.querySelectorAll('#classSelectionArea input[type=checkbox]'));
            const selected = boxes.filter(b => b.checked).map(b => ({ class: b.dataset.cls, section: b.dataset.sec }));
            currentTeacher.assignedClasses = selected;

            // persist to DB and loggedInUser
            const dbLocal = getUsersDB();
            const ti = dbLocal.teachers.findIndex(t => t.id === currentTeacher.id);
            if (ti >= 0) {
                dbLocal.teachers[ti].assignedClasses = selected;
            }
            saveUsersDB(dbLocal);
            saveLoggedInUser(Object.assign(getLoggedInUser() || {}, { assignedClasses: selected }));

            document.getElementById('teacherClass').textContent = selected.length ? formatAssignedClasses(selected) : 'No classes selected';
            renderStudentsList();
            refreshActivityStatus();
        }

        // Filter students for this teacher
        function getManagedStudents() {
            if (!currentTeacher.assignedClasses || currentTeacher.assignedClasses.length === 0) return [];
            return db.students.filter(s => currentTeacher.assignedClasses.some(a => a.class === (s.class || 'Unassigned') && (a.section || '') === (s.section || '')) );
        }

        function renderStudentsList() {
            const listContainer = document.getElementById('studentMarks');
            const selectEl = document.getElementById('studentSelect');
            listContainer.innerHTML = '';
            selectEl.innerHTML = '<option value="">-- Select Student --</option>';

            const students = getManagedStudents();
            if (students.length === 0) {
                listContainer.innerHTML = '<div class="inactive-notice"><p>No students found for your selected classes. Please select classes/sections above.</p></div>';
                renderActivityTable(students);
                renderAssignmentsPanel();
                return;
            }

            // award daily +0.5 marks once per day if student joined today
            const todayKey = new Date().toISOString().slice(0,10);
            let dbLocal = getUsersDB();
            let updated = false;
            students.forEach(s => {
                const lastDaily = s.lastDailyMarkDate || '';
                if (s.lastActive) {
                    const lastActiveDate = new Date(s.lastActive).toISOString().slice(0,10);
                    if (lastActiveDate === todayKey && lastDaily !== todayKey) {
                        s.marks = (Number(s.marks) || 0) + 0.5;
                        s.lastDailyMarkDate = todayKey;
                        updated = true;
                    }
                }
            });
            if (updated) {
                // persist updates to DB
                dbLocal.students = db.students.map(st => {
                    const found = students.find(x => x.id === st.id);
                    return found ? Object.assign(st, found) : st;
                });
                saveUsersDB(dbLocal);
                db = dbLocal;
            }

            // apply search and sort
            const search = (document.getElementById('studentSearch').value || '').toLowerCase().trim();
            let filtered = students.filter(s => {
                const name = `${s.firstName} ${s.lastName}`.toLowerCase();
                return !search || name.includes(search);
            });
            const sortBy = document.getElementById('studentSort').value || 'name';
            filtered.sort((a,b) => {
                if (sortBy === 'name') return (`${a.firstName} ${a.lastName}`).localeCompare(`${b.firstName} ${b.lastName}`);
                if (sortBy === 'marks') return (Number(b.marks||0) - Number(a.marks||0));
                return 0;
            });

            filtered.forEach(s => {
                s.homeworks = s.homeworks || [];
                const item = document.createElement('div');
                item.className = 'student-item';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'student-name';
                nameSpan.textContent = `${s.firstName} ${s.lastName}`;

                const hwSpan = document.createElement('span');
                hwSpan.className = 'marks-display';
                hwSpan.textContent = `${s.homeworks.length} HWs`;

                const marksInput = document.createElement('input');
                marksInput.type = 'number';
                marksInput.min = 0; marksInput.max = 100;
                marksInput.value = s.marks || 0;
                marksInput.style.width = '72px';
                marksInput.style.padding = '6px';
                marksInput.style.border = '1px solid #e6e9f8';
                marksInput.style.borderRadius = '6px';
                marksInput.addEventListener('change', () => {
                    const v = Number(marksInput.value);
                    if (!isNaN(v) && v >=0 && v <=100) {
                        const dbNow = getUsersDB();
                        const stu = dbNow.students.find(x => x.id == s.id);
                        if (stu) {
                            stu.marks = v;
                            saveUsersDB(dbNow);
                            db = dbNow;
                            updateTeacherActivity();
                            renderActivityTable(getManagedStudents());
                        }
                    } else {
                        alert('Enter a value 0-100');
                        marksInput.value = s.marks || 0;
                    }
                });

                const viewBtn = document.createElement('button');
                viewBtn.className = 'edit-marks-btn';
                viewBtn.textContent = 'View';
                viewBtn.addEventListener('click', () => viewStudentMarks(s.id));

                item.appendChild(nameSpan);
                item.appendChild(hwSpan);
                item.appendChild(marksInput);
                item.appendChild(viewBtn);

                listContainer.appendChild(item);

                const opt = document.createElement('option');
                opt.value = s.id; opt.textContent = `${s.firstName} ${s.lastName}`;
                selectEl.appendChild(opt);
            });

            renderActivityTable(students);
            renderAssignmentsPanel();
        }

        function renderActivityTable(students) {
            const tbody = document.querySelector('.activity-table tbody');
            tbody.innerHTML = '';
            students.forEach(s => {
                s.homeworks = s.homeworks || [];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.firstName} ${s.lastName}</td>
                    <td>${s.lastActive ? timeAgo(s.lastActive) : 'N/A'}</td>
                    <td>${(s.lastActive && (Date.now() - s.lastActive) < 24*3600000) ? '<span class="activity-status status-active">Active</span>' : '<span class="activity-status status-inactive">Inactive</span>'}</td>
                    <td>${s.homeworks.length}/${s.homeworks.length}</td>
                    <td>${s.marks || 0}</td>
                    <td><button class="edit-marks-btn" onclick="alert('Message sent to ${s.firstName} ${s.lastName}')">Message</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function timeAgo(ts) {
            const diff = Date.now() - ts;
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return Math.round(diff/60000) + ' mins ago';
            if (diff < 86400000) return Math.round(diff/3600000) + ' hours ago';
            return Math.round(diff/86400000) + ' days ago';
        }

        function refreshActivityStatus() {
            const students = getManagedStudents();
            let activeCount = 0;
            let ongoingCount = 0;
            let needHelpCount = 0;
            students.forEach(s => {
                if (s.lastActive && (Date.now() - s.lastActive) < 24*3600000) activeCount++; // 24h active
                // count assignments in last 7 days
                const recentHomeworks = (s.homeworks || []).filter(h => h.createdAt && (Date.now() - h.createdAt) <= 7*24*3600000);
                ongoingCount += recentHomeworks.length;
                if (!s.lastActive || (Date.now() - s.lastActive) > 2*3600000) needHelpCount++;
            });

            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('ongoingCount').textContent = ongoingCount;
            document.getElementById('needHelpCount').textContent = needHelpCount;
        }

        function computeWeeklyLoad() {
            const students = getManagedStudents();
            let total = 0;
            students.forEach(s => {
                const recent = (s.homeworks || []).filter(h => h.createdAt && (Date.now() - h.createdAt) <= 7*24*3600000);
                total += recent.reduce((sum, h) => sum + (Number(h.duration) || 0), 0);
            });
            return total;
        }

        function checkTeacherInactivity() {
            const dbLocal = getUsersDB();
            const t = dbLocal.teachers.find(x => x.id === currentTeacher.id) || currentTeacher;
            const last = t.lastActivity || t.lastLogin || 0;
            const fortyEight = 48 * 3600000;
            if (!last || (Date.now() - last) > fortyEight) {
                document.getElementById('teacherInactiveNotif').style.display = 'flex';
            } else {
                document.getElementById('teacherInactiveNotif').style.display = 'none';
            }
        }

        // Difficulty selector
        function selectDifficulty(level) {
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('selectedDifficulty').value = level;
            updateComposerPreview();
        }

        // Set priority -> send homework to selected classes
        function setPriority() {
            const topic = document.getElementById('priorityTopic').value;
            const difficulty = document.getElementById('selectedDifficulty').value;
            const duration = document.getElementById('priorityDuration').value;
            const description = document.getElementById('priorityDescription').value;

            if (!topic || !difficulty || !duration) {
                alert('‚ö†Ô∏è Please fill in all fields!');
                return;
            }

            const hw = { id: Date.now(), topic, difficulty, duration: Number(duration), description, assignedBy: currentTeacher.id, createdAt: Date.now() };
            const assigned = sendHomeworkToManagedStudents(hw);

            // update teacher last activity
            updateTeacherActivity();

            const successDiv = document.getElementById('prioritySuccess');
            successDiv.style.display = 'block';
            successDiv.innerHTML = `‚úÖ Homework "${topic}" sent to ${getManagedStudents().length} students.`;

            document.getElementById('priorityTopic').value = '';
            document.getElementById('priorityDuration').value = '';
            document.getElementById('priorityDescription').value = '';
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('selectedDifficulty').value = '';

            setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
        }

        function sendHomeworkToManagedStudents(hw) {
            const dbLocal = getUsersDB();
            const students = dbLocal.students;
            let assignedCount = 0;
            students.forEach(s => {
                if (currentTeacher.assignedClasses.some(a => a.class === (s.class || 'Unassigned') && (a.section || '') === (s.section || ''))) {
                    s.homeworks = s.homeworks || [];
                    s.homeworks.push(hw);
                    assignedCount++;
                }
            });
            saveUsersDB(dbLocal);
            db = dbLocal;
            renderStudentsList();
            refreshActivityStatus();
            return assignedCount;
        }

        // Assignments panel: list assignments across students for teacher's sections
        function renderAssignmentsPanel() {
            const container = document.getElementById('assignmentsList');
            container.innerHTML = '';
            const students = getManagedStudents();
            const map = {}; // hwId -> {hw, sections:Set}
            students.forEach(s => {
                (s.homeworks || []).forEach(h => {
                    if (!h || !h.id) return;
                    if (!map[h.id]) map[h.id] = { hw: h, sections: new Set() };
                    map[h.id].sections.add(s.section || '');
                });
            });

            const keys = Object.keys(map);
            if (keys.length === 0) {
                container.innerHTML = '<div style="color:#666;font-size:13px;">No assignments for your sections.</div>';
                return;
            }

            keys.forEach(id => {
                const ent = map[id];
                const hw = ent.hw;
                const card = document.createElement('div');
                card.style.display = 'flex';
                card.style.justifyContent = 'space-between';
                card.style.alignItems = 'center';
                card.style.background = '#f8fafc';
                card.style.padding = '10px';
                card.style.borderRadius = '8px';

                const left = document.createElement('div');
                left.innerHTML = `<strong>${hw.topic}</strong><div style="font-size:13px;color:#666;">${Array.from(ent.sections).join(', ')} ‚Ä¢ ${hw.duration || 0} min</div>`;

                const right = document.createElement('div');
                right.style.display = 'flex';
                right.style.gap = '8px';

                const completeBtn = document.createElement('button');
                completeBtn.className = 'btn-primary';
                completeBtn.textContent = hw.status === 'completed' ? 'Completed' : 'Mark Completed';
                completeBtn.onclick = () => markAssignmentCompleted(hw.id);

                const delBtn = document.createElement('button');
                delBtn.className = 'delete-btn';
                delBtn.textContent = 'Remove';
                delBtn.onclick = () => deleteAssignment(hw.id);

                right.appendChild(completeBtn);
                right.appendChild(delBtn);
                card.appendChild(left);
                card.appendChild(right);
                container.appendChild(card);
            });
        }

        function markAssignmentCompleted(hwId) {
            const dbLocal = getUsersDB();
            dbLocal.students.forEach(s => {
                s.homeworks = (s.homeworks || []).map(h => {
                    if (h.id === hwId && currentTeacher.assignedClasses.some(a => a.class === (s.class||'Unassigned') && (a.section||'') === (s.section||''))) {
                        h.status = 'completed';
                        h.completedAt = Date.now();
                    }
                    return h;
                });
            });
            saveUsersDB(dbLocal);
            db = dbLocal;
            renderStudentsList();
            renderAssignmentsPanel();
        }

        function deleteAssignment(hwId) {
            if (!confirm('Remove this assignment for all students in your sections?')) return;
            const dbLocal = getUsersDB();
            dbLocal.students.forEach(s => {
                if (currentTeacher.assignedClasses.some(a => a.class === (s.class||'Unassigned') && (a.section||'') === (s.section||''))) {
                    s.homeworks = (s.homeworks || []).filter(h => h.id !== hwId);
                }
            });
            saveUsersDB(dbLocal);
            db = dbLocal;
            renderStudentsList();
            renderAssignmentsPanel();
        }

        function exportAssignments() {
            const students = getManagedStudents();
            const map = {};
            students.forEach(s => (s.homeworks||[]).forEach(h => map[h.id] = h));
            const arr = Object.values(map);
            const data = JSON.stringify(arr, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'assignments.json';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }

        function importAssignments() {
            const raw = prompt('Paste assignments JSON array');
            if (!raw) return;
            try {
                const arr = JSON.parse(raw);
                const dbLocal = getUsersDB();
                arr.forEach(hw => {
                    // assign to students in current teacher sections
                    dbLocal.students.forEach(s => {
                        if (currentTeacher.assignedClasses.some(a => a.class === (s.class||'Unassigned') && (a.section||'') === (s.section||''))) {
                            s.homeworks = s.homeworks || [];
                            s.homeworks.push(hw);
                        }
                    });
                });
                saveUsersDB(dbLocal);
                db = dbLocal;
                renderStudentsList();
                renderAssignmentsPanel();
                alert('Import complete');
            } catch (e) {
                alert('Invalid JSON');
            }
        }

        function viewStudentMarks(studentId) {
            const dbLocal = getUsersDB();
            const s = dbLocal.students.find(x => x.id == studentId);
            if (!s) return alert('Student not found');
            document.getElementById('modalStudentName').value = `${s.firstName} ${s.lastName}`;
            document.getElementById('modalMarks').value = s.marks || 0;
            document.getElementById('editMarksModal').classList.add('active');
            window.currentEditStudent = { studentId };
        }

        function updateTeacherActivity() {
            const dbLocal = getUsersDB();
            const ti = dbLocal.teachers.findIndex(t => t.id === currentTeacher.id);
            const now = Date.now();
            if (ti >= 0) {
                dbLocal.teachers[ti].lastActivity = now;
            }
            // also update loggedInUser
            const logged = getLoggedInUser() || {};
            logged.lastActivity = now;
            saveLoggedInUser(logged);
            saveUsersDB(dbLocal);
            currentTeacher.lastActivity = now;
        }

        function quickAddSuggested() {
            const hw = { id: Date.now(), topic: 'Quick practice', difficulty: 'easy', duration: 15, description: 'Short practice', assignedBy: currentTeacher.id, createdAt: Date.now() };
            const assigned = sendHomeworkToManagedStudents(hw);
            updateTeacherActivity();
            alert(`‚úÖ Added ${assigned} assignments (15 min each).`);
        }

        function openQuickComposer() {
            document.getElementById('priorityTopic').focus();
            document.getElementById('priorityTopic').value = 'Quick practice';
            document.getElementById('priorityDuration').value = 15;
            document.querySelectorAll('.difficulty-btn.easy').forEach(b => b.classList.add('selected'));
            document.getElementById('selectedDifficulty').value = 'easy';
            updateComposerPreview();
        }

        function openGradebook() {
            window.scrollTo({ top: document.querySelector('.card').offsetTop, behavior: 'smooth' });
        }

        function updateComposerPreview() {
            const topic = document.getElementById('priorityTopic').value;
            const duration = Number(document.getElementById('priorityDuration').value) || 0;
            const diff = document.getElementById('selectedDifficulty').value || 'N/A';
            const weekly = computeWeeklyLoad();
            const newTotal = weekly + duration;
            const preview = `Topic: ${topic || '(untitled)'} ‚Äî Difficulty: ${diff.toUpperCase()} ‚Äî Duration: ${duration} min. This will change weekly load from ${weekly} min to ${newTotal} min.`;
            document.getElementById('composerPreview').textContent = preview;
        }

        // Add marks
        function addMarks() {
            const studentId = document.getElementById('studentSelect').value;
            const marks = parseInt(document.getElementById('marksInput').value);

            if (!studentId || isNaN(marks) || marks < 0 || marks > 100) {
                alert('‚ö†Ô∏è Please select a student and enter valid marks (0-100)!');
                return;
            }

            const dbLocal = getUsersDB();
            const s = dbLocal.students.find(x => x.id == studentId);
            if (s) {
                s.marks = marks;
                saveUsersDB(dbLocal);
                alert(`‚úÖ Marks updated for ${s.firstName} ${s.lastName}!`);
                document.getElementById('studentSelect').value = '';
                document.getElementById('marksInput').value = '';
                db = dbLocal;
                renderStudentsList();
                updateTeacherActivity();
            }
        }

        // Edit mark modal
        function editMarkModal(studentId, studentName, marks) {
            document.getElementById('modalStudentName').value = studentName;
            document.getElementById('modalMarks').value = marks;
            document.getElementById('editMarksModal').classList.add('active');
            window.currentEditStudent = { studentId };
        }
        function saveMarkChanges() {
            const newMarks = parseInt(document.getElementById('modalMarks').value);

            if (isNaN(newMarks) || newMarks < 0 || newMarks > 100) {
                alert('‚ö†Ô∏è Please enter valid values!');
                return;
            }

            const dbLocal = getUsersDB();
            const s = dbLocal.students.find(x => x.id == window.currentEditStudent.studentId);
            if (s) {
                s.marks = newMarks;
                saveUsersDB(dbLocal);
                db = dbLocal;
                closeModal('editMarksModal');
                alert('‚úÖ Changes saved successfully!');
                renderStudentsList();
                renderActivityTable(getManagedStudents());
                updateTeacherActivity();
            }
        }

        // Utility: close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('userRole');
                window.location.href = 'login.html';
            }
        }

        // click outside modal close
        window.onclick = function(event) {
            const modal = document.getElementById('editMarksModal');
            if (event.target === modal) {
                modal.classList.remove('active');
            }
        }
    </script>
</body>
</html>
